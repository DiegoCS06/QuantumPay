@page
@using Microsoft.AspNetCore.Authorization
@model WebApp.Pages.ComercioPages.ComercioHomeModel
@{
    var comercio = Model.Comercio;
    ViewData["Title"] = "Inicio Comercio";
}
@attribute [Authorize(Roles = "CuentaComercio")]

<h2 class="mb-4">Panel del Comercio</h2>

<!-- Botón para abrir el modal de nuevo comercio (siempre visible) -->
<button type="button" class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#crearComercioModal">
    Nuevo Comercio
</button>

<!-- Modal con el formulario para crear comercio -->
<div class="modal fade" id="crearComercioModal" tabindex="-1" aria-labelledby="crearComercioModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="crearComercioModalLabel">Registrar Nuevo Comercio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                @await Html.PartialAsync("_RegistrarComercioPartial", Model)
            </div>
        </div>
    </div>
</div>

@if (comercio != null && comercio.estadoSolicitud.ToLower().StartsWith("aprobad"))
{
    <h3>Transacciones del Comercio</h3>
    <div>Cantidad de transacciones: @Model.Transacciones?.Count</div>
    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Cliente</th>
                <th>Código Banco</th>
                <th>Monto</th>
                <th>Fecha</th>
                <th>Método de Pago</th>
            </tr>
        </thead>
        <tbody>
            @if (Model.Transacciones != null && Model.Transacciones.Any())
            {
                foreach (var t in Model.Transacciones)
                {
                    <tr>
                        <td>@t.Id</td>
                        <td>@t.NombreCliente</td>
                        <td>@t.CodigoIdentidadInstitucionBancaria</td>
                        <td>@t.Monto</td>
                        <td>@t.Fecha.ToShortDateString()</td>
                        <td>@t.MetodoPago</td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="6" class="text-center">No hay transacciones registradas.</td>
                </tr>
            }
        </tbody>
    </table>

    <h3>Agregar Administrador</h3>
    <button id="btnMostrarAdminForm" type="button" class="btn btn-primary mb-3">
        Agregar administrador para comercio
    </button>

    <div id="adminFormContainer" style="display:none;">
        <form method="post" asp-page-handler="AgregarAdmin">
            @Html.AntiForgeryToken()
            <div class="mb-3">
                <label asp-for="NuevoAdmin.NombreUsuario"></label>
                <input asp-for="NuevoAdmin.NombreUsuario" class="form-control" />
                <span asp-validation-for="NuevoAdmin.NombreUsuario" class="text-danger"></span>
            </div>
            <div class="mb-3">
                <label asp-for="NuevoAdmin.CorreoElectronico"></label>
                <input asp-for="NuevoAdmin.CorreoElectronico" class="form-control" />
                <span asp-validation-for="NuevoAdmin.CorreoElectronico" class="text-danger"></span>
            </div>
            <div class="mb-3">
                <label asp-for="NuevoAdmin.CedulaJuridica"></label>
                <input asp-for="NuevoAdmin.CedulaJuridica" class="form-control" />
                <span asp-validation-for="NuevoAdmin.CedulaJuridica" class="text-danger"></span>
            </div>
            <div class="mb-3">
                <label asp-for="NuevoAdmin.Direccion"></label>
                <input asp-for="NuevoAdmin.Direccion" class="form-control" />
                <span asp-validation-for="NuevoAdmin.Direccion" class="text-danger"></span>
            </div>
            <div class="mb-3">
                <label asp-for="NuevoAdmin.Telefono"></label>
                <input asp-for="NuevoAdmin.Telefono" class="form-control" type="number" />
                <span asp-validation-for="NuevoAdmin.Telefono" class="text-danger"></span>
            </div>
            <div class="mb-3">
                <label asp-for="NuevoAdmin.Contrasena"></label>
                <input asp-for="NuevoAdmin.Contrasena" class="form-control" type="password" />
                <span asp-validation-for="NuevoAdmin.Contrasena" class="text-danger"></span>
            </div>
            <button type="submit" class="btn btn-primary">Agregar Administrador</button>
        </form>
        @if (ViewData["AdminCreado"] != null)
        {
            <div class="alert alert-success mt-3">@ViewData["AdminCreado"]</div>
        }
        @if (ViewData["AdminError"] != null)
        {
            <div class="alert alert-danger mt-3">@ViewData["AdminError"]</div>
        }
    </div>

    <div class="mt-4">
        <a asp-page="/ComercioPages/Promociones" class="btn btn-secondary">Administrar Promociones</a>
    </div>
}

@if (Model.Comercio == null)
{
    <div class="alert alert-warning">No se encontró un comercio asociado a esta cuenta.</div>
}

else if (comercio.estadoSolicitud == "rechazada")
{
    <div class="alert alert-danger">
        Su comercio de nombre: <strong>@comercio.Nombre</strong> fue rechazado. Por favor contacte al soporte.
    </div>
}
else if (comercio.estadoSolicitud == "pendiente")
{
    <div class="alert alert-info">
        Su comercio está pendiente de aprobación. Espere la validación del administrador.
    </div>
}

@if (ViewData["ClaimsInfo"] != null)
{
    <div>@ViewData["ClaimsInfo"]</div>
}
@if (ViewData["ComercioError"] != null)
{
    <div class="alert alert-danger mt-3">@ViewData["ComercioError"]</div>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var btn = document.getElementById('btnMostrarAdminForm');
            if (btn) {
                btn.addEventListener('click', function () {
                    var container = document.getElementById('adminFormContainer');
                    if (container.style.display === 'none' || container.style.display === '') {
                        container.style.display = 'block';
                    } else {
                        container.style.display = 'none';
                    }
                });
            }
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Solo abre el modal si el submit fue del formulario de comercio
            var abrirModal = '@ViewData["AbrirModalComercio"]' === 'True';
            if (abrirModal) {
                var modal = new bootstrap.Modal(document.getElementById('crearComercioModal'));
                modal.show();
            }
        });
    </script>
}